# Deployment Guide - touch-timeout v2.0.0

This guide covers cross-compilation and deployment of touch-timeout to Raspberry Pi 4 from WSL2.

## Overview

The deployment strategy is designed for zero-downtime updates with easy rollback:

1. **Local Build (WSL2)**: Cross-compile binary for target architecture (ARM 32/64-bit)
2. **Staging Transfer**: Deploy to RPi4 temporary location via SCP
3. **Final Installation**: Run installation script on RPi4 to manage versioning and symlinks
4. **Symlink Strategy**: All systemd references use `/usr/bin/touch-timeout` symlink for atomic updates

## Architecture

### Directory Structure

```
touch-timeout/
├── Makefile                    # Main build system
├── scripts/
│   ├── deploy-arm.sh          # WSL2-side: compile + transfer
│   └── install-on-rpi.sh      # RPi4-side: install + symlink + restart
├── build/
│   ├── arm32/touch-timeout    # 32-bit ARM binary (after make arm32)
│   ├── arm64/touch-timeout    # 64-bit ARM binary (after make arm64)
│   └── native/touch-timeout   # Native compilation (after make)
├── src/
│   ├── main.c
│   ├── config.c
│   ├── display.c
│   ├── input.c
│   ├── state.c
│   └── timer.c
└── include/
    └── version.h              # Auto-generated by Makefile
```

### RPi4 Installation Layout

```
/usr/bin/
├── touch-timeout              # SYMLINK → touch-timeout-2.0.0-arm64
├── touch-timeout-2.0.0-arm64  # Current version (v2.0.0, ARM 64-bit)
├── touch-timeout-1.9.5-arm64  # Previous version (easy rollback)
└── touch-timeout-1.9.0-arm64  # Earlier version (archive)

/etc/
├── touch-timeout.conf         # Configuration (preserved across updates)
└── systemd/system/
    └── touch-timeout.service  # Unchanged - references /usr/bin/touch-timeout
```

## Prerequisites

### On WSL2 Host

1. **Install cross-compilation toolchains**:
   ```bash
   sudo apt-get update
   sudo apt-get install gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu
   ```

2. **Verify toolchains**:
   ```bash
   arm-linux-gnueabihf-gcc --version     # For ARM 32-bit
   aarch64-linux-gnu-gcc --version       # For ARM 64-bit
   ```

3. **Network access**: SSH must be accessible on RPi4 at `192.1.1.X`

### On RPi4 Target

1. **SSH enabled** (systemd openssh-server running)
2. **Root access** (or passwordless sudo for non-root user)
3. **systemd** with touch-timeout.service installed (from initial v1.x installation)
4. **/tmp** must be writable (staging location during deployment)

## Quick Start

### Example: Deploy ARM 64-bit to RPi4 at 192.1.1.127

**Step 1: Compile and transfer from WSL2**
```bash
cd /path/to/touch-timeout
./scripts/deploy-arm.sh 127 arm64
```

**Step 2: SSH into RPi4 and install**
```bash
ssh root@192.1.1.127
sudo /tmp/touch-timeout-staging/install-on-rpi.sh
```

That's it! The service will restart automatically with the new binary.

## Detailed Workflow

### Step 1: WSL2 Compilation and Transfer

**Command**:
```bash
./scripts/deploy-arm.sh <IP_OCTETS> [arm32|arm64]
```

**Parameters**:
- `<IP_OCTETS>`: Last 3 digits of IP (e.g., `127` for `192.168.1.127`)
- `[arm32|arm64]`: Architecture (default: `arm64`)

**What the script does**:
1. Validates input (IP range, architecture)
2. Verifies SSH connectivity to RPi4
3. Cross-compiles binary with optimized flags:
   - ARM 32-bit: `-march=armv7-a -mfpu=neon` (optimized for RPi4)
   - ARM 64-bit: `-march=armv8-a` (64-bit ARMv8)
4. Verifies compilation succeeded
5. Creates staging directory: `/tmp/touch-timeout-staging/`
6. Transfers binary via SCP (secure copy)
7. Transfers install script
8. Prints next steps with SSH command

**Output Example**:
```
[INFO] Configuration:
[INFO]   Target IP: 192.168.1.127
[INFO]   Architecture: arm64
[INFO]   Staging dir: /tmp/touch-timeout-staging

[INFO] Verifying SSH connectivity to 192.168.1.127...
[OK] SSH connectivity verified

[INFO] Building touch-timeout for arm64...
[OK] Build completed: build/arm64/touch-timeout

[OK] Binary transferred
[OK] Install script transferred

========================================
[OK] Deployment package ready on RPi4
========================================

[INFO] Next steps:
  1. SSH into RPi4:
     ssh root@192.1.1.127

  2. Run the installation script:
     sudo /tmp/touch-timeout-staging/install-on-rpi.sh
```

### Step 2: RPi4 Installation and Activation

**Command** (run on RPi4):
```bash
sudo /tmp/touch-timeout-staging/install-on-rpi.sh
```

**What the script does**:
1. Verifies running as root
2. Detects binary architecture (via `file` command)
3. Stops running service (if active)
4. Installs binary with version and architecture suffix:
   - Example: `/usr/bin/touch-timeout-2.0.0-arm64`
5. Lists previous versions for rollback reference
6. Updates symlink atomically:
   - Creates new symlink as: `/usr/bin/touch-timeout.new`
   - Moves over old: `/usr/bin/touch-timeout` ← atomic operation
7. Verifies binary executable
8. Reloads systemd configuration
9. Starts touch-timeout service
10. Shows status and logs

**Output Example**:
```
[INFO] Installation starting...

[INFO] Detecting binary architecture...
[OK] Architecture detected: arm64

[INFO] Installation details:
[INFO]   Binary: /usr/bin/touch-timeout-2.0.0-arm64
[INFO]   Symlink: /usr/bin/touch-timeout

[INFO] Stopping touch-timeout service...
[OK] Service stopped

[OK] Binary installed: /usr/bin/touch-timeout-2.0.0-arm64

[INFO] Previous versions:
  /usr/bin/touch-timeout-1.9.5-arm64 (2.5M)

[INFO] Updating symlink: /usr/bin/touch-timeout → /usr/bin/touch-timeout-2.0.0-arm64
[OK] Symlink updated

[INFO] Reloading systemd configuration...
[OK] Systemd reloaded

[INFO] Starting touch-timeout service...
[OK] Service started and running

========================================
[OK] Installation complete!
========================================

[INFO] Binary: /usr/bin/touch-timeout-2.0.0-arm64
[INFO] Symlink: /usr/bin/touch-timeout → /usr/bin/touch-timeout-2.0.0-arm64

[INFO] View logs:
  journalctl -u touch-timeout.service -f

[INFO] Rollback to previous version:
  ln -sf /usr/bin/touch-timeout-<VERSION>-<ARCH> /usr/bin/touch-timeout
  sudo systemctl restart touch-timeout.service
```

## Build Targets

### Local (Native) Build

```bash
make          # Build for local architecture (WSL2)
make test     # Run unit tests
make coverage # Generate coverage report
make clean    # Clean local build
```

### Cross-Compilation Targets

```bash
make arm32    # Build for ARM 32-bit (armv7l) → build/arm32/touch-timeout
make arm64    # Build for ARM 64-bit (aarch64) → build/arm64/touch-timeout
make clean-all  # Remove all build artifacts (including build/ directory)
```

## Rollback Strategy

If a deployment fails or you need to revert to a previous version:

### Option 1: Quick Rollback via Symlink (Recommended)

SSH into RPi4 and update the symlink:
```bash
# List available versions
ls -lh /usr/bin/touch-timeout*

# Point symlink to previous version
sudo ln -sf /usr/bin/touch-timeout-2.0.0-arm64 /usr/bin/touch-timeout

# Restart service
sudo systemctl restart touch-timeout.service

# Verify
journalctl -u touch-timeout.service -n 20
```

### Option 2: Redeploy

If the previous binary is unavailable, redeploy from WSL2:
```bash
./scripts/deploy-arm.sh 127 arm64
# Then SSH and run install script again
```

## Troubleshooting

### Build Fails: "command not found: arm-linux-gnueabihf-gcc"

**Issue**: Cross-compiler toolchain not installed

**Fix**:
```bash
sudo apt-get install gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu
```

### Deploy Fails: "Cannot connect to root@192.1.1.X"

**Issue**: RPi4 not reachable or SSH not enabled

**Checks**:
```bash
# Verify RPi4 is online
ping 192.1.1.127

# Verify SSH is accessible
ssh root@192.1.1.127 "echo ok"

# Check RPi4 systemd openssh status
ssh root@192.1.1.127 "systemctl status ssh"
```

### Service Won't Start After Deployment

**Check**:
```bash
sudo systemctl status touch-timeout.service
journalctl -u touch-timeout.service -n 50 --no-pager
```

**Common causes**:
- Binary doesn't exist: Verify symlink target exists
- Configuration error: Check `/etc/touch-timeout.conf`
- Permission denied: Binary must be executable
- Device not found: Check `/dev/input/event0` exists

### Rollback Fails: "touch-timeout-X.Y.Z not found"

**Issue**: Previous version binary was deleted

**Solution**: Redeploy current version or restore from backup

## Advanced Usage

### Deploy Both Architectures

```bash
# Deploy 32-bit
./scripts/deploy-arm.sh 127 arm32
ssh root@192.1.1.127 "sudo /tmp/touch-timeout-staging/install-on-rpi.sh"

# Wait for verification, then deploy 64-bit
./scripts/deploy-arm.sh 127 arm64
ssh root@192.1.1.127 "sudo /tmp/touch-timeout-staging/install-on-rpi.sh"
```

### Automated Deployment (CI/CD)

```bash
#!/bin/bash
set -e

# Compile
./scripts/deploy-arm.sh 127 arm64

# Install without interactive prompt (requires passwordless sudo)
ssh root@192.1.1.127 "sudo /tmp/touch-timeout-staging/install-on-rpi.sh"

# Verify
ssh root@192.1.1.127 "systemctl is-active touch-timeout.service && echo 'OK'"
```

### Custom IP Configuration

Edit deploy-arm.sh to use different IP prefix:
```bash
RPI_IP_PREFIX="10.0.0"    # Change from 192.1.1
./scripts/deploy-arm.sh 127 arm64   # Now targets 10.0.0.127
```

## Version and Compatibility

- **touch-timeout**: v2.0.0 (modular)
- **C Standard**: C17 (ISO/IEC 9899:2018)
- **POSIX**: POSIX.1-2008 with _POSIX_C_SOURCE=200809L
- **Target Systems**: Raspberry Pi 4 (ARMv8-a), Raspberry Pi 3 (ARMv7-a)
- **Systemd**: Optional (gracefully degrades if unavailable)

## See Also

- **INSTALLATION.md**: Initial installation and configuration
- **Makefile**: Build system documentation
- **README.md**: Feature overview and configuration reference
- **CLAUDE.md**: Architecture and coding standards
