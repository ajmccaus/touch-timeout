# Makefile for touch-timeout unit tests
#
# Tests pure modules (state machine, main.c calculations) with coverage

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -D_GNU_SOURCE -I../src -I../include -DUNIT_TEST
COVERAGE_CFLAGS = --coverage -fprofile-arcs -ftest-coverage -g
LDFLAGS = --coverage

SRC_DIR = ../src

.PHONY: all test clean coverage help version

all: test_state

# Ensure version.h exists (generated by parent Makefile)
version:
	$(MAKE) -C .. version

# Build state module object with coverage
state_test.o: $(SRC_DIR)/state.c
	$(CC) $(CFLAGS) $(COVERAGE_CFLAGS) -c -o $@ $<

# Link test executable (main.c included via #include in test_state.c)
test_state: version test_state.c state_test.o
	$(CC) $(CFLAGS) $(COVERAGE_CFLAGS) -o $@ test_state.c state_test.o $(LDFLAGS)

# Run tests
test: test_state
	./test_state

# Generate coverage report
coverage: test
	@echo ""
	@echo "Generating coverage report..."
	@if command -v lcov >/dev/null 2>&1; then \
		mkdir -p coverage; \
		lcov --capture --directory . --output-file coverage/coverage.info 2>/dev/null || true; \
		lcov --remove coverage/coverage.info '/usr/*' --output-file coverage/coverage.info 2>/dev/null || true; \
		genhtml coverage/coverage.info --output-directory coverage 2>/dev/null || true; \
		echo "Coverage report: coverage/index.html"; \
	else \
		echo "lcov not installed. Using gcov:"; \
		gcov *.gcda 2>/dev/null || true; \
	fi

# Clean
clean:
	rm -f test_state *.o *.gcda *.gcno *.gcov
	rm -rf coverage

help:
	@echo "  make       - Build tests"
	@echo "  make test  - Run tests"
	@echo "  make clean - Remove artifacts"
